# ğŸŒŸ OpenResty Base Image
# =======================
FROM openresty/openresty:alpine-fat
RUN echo "Why did the OpenResty server feel lonely? Because it had no cache friends! ğŸ˜„"

# ğŸ“¦ Install Dependencies
# =====================
RUN echo "What did the package manager say to the dependencies? I APK you a question! ğŸ¤£" && \
    apk add --no-cache \
    bash \
    openssl \
    curl \
    perl \
    git \
    build-base \
    pcre-dev \
    zlib-dev \
    luarocks

# ğŸ”§ Install LuaRocks Packages
# ==========================
RUN echo "Why do Lua developers make great rockstars? Because they know how to handle their LuaRocks! ğŸ¸" && \
    luarocks install lua-resty-auto-ssl

# ğŸ“‚ Create Required Directories
# ===========================
RUN echo "What's a directory's favorite dance move? The mkdir shuffle! ğŸ’ƒ" && \
    mkdir -p /etc/resty-auto-ssl \
    /etc/nginx/conf.d \
    /etc/nginx/sites-enabled \
    /etc/nginx/ssl \
    /var/log/nginx \
    /var/cache/nginx \
    /etc/nginx

# ğŸ” Set Permissions
# ================
RUN echo "Why did the chmod 777 feel insecure? Because it was too open about everything! ğŸ”“" && \
    chown -R nobody:nobody /etc/resty-auto-ssl && \
    chmod -R 700 /etc/resty-auto-ssl && \
    chmod 755 /etc/nginx/conf.d && \
    chmod 755 /etc/nginx/sites-enabled && \
    chmod 755 /etc/nginx/ssl

# ğŸ“ Copy Configuration Files
# ========================
RUN echo "What did one config file say to another? You auto know this by now! ğŸ“„"
COPY ./conf.d/default.conf /etc/nginx/conf.d/default.conf
COPY ./mime.types /etc/nginx/mime.types
COPY ./nginx.conf /usr/local/openresty/nginx/conf/nginx.conf

# ğŸš€ Copy Entrypoint Script
# =======================
RUN echo "Why did the entrypoint script go to therapy? It had too many execution issues! ğŸš€"
COPY ./scripts/entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# ğŸ”Œ Expose Ports
# =============
RUN echo "What's a port's favorite music? Whatever's streaming! ğŸµ"
EXPOSE 80 443

# âš¡ Set Entrypoint
# ==============
RUN echo "What's an entrypoint's favorite game? Docker, docker, goose! ğŸ¦¢"
ENTRYPOINT ["/docker-entrypoint.sh"]

# ğŸ¯ Default Command
# ===============
RUN echo "Why did the daemon refuse to quit? Because it was commanded not to! ğŸ˜‰"
CMD ["openresty", "-g", "daemon off;"]
